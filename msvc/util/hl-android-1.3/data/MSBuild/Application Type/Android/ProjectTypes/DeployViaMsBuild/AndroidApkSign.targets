<?xml version="1.0" encoding="utf-8"?>
<Project xmlns="http://schemas.microsoft.com/developer/msbuild/2003">

  <!--
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
  -->

  <ItemGroup>
    <PropertyPageSchema Include="$(MSBuildThisFileDirectory)$(MSBuildThisFileName).xml" />
  </ItemGroup>

  <!--
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
  -->

  <UsingTask TaskName="JavaSigner" AssemblyFile="$(VCTargetsPath)\Application Type\Android\bin\Android.MsBuild.DeployTasks.dll" />

  <UsingTask TaskName="AndroidZipAlign" AssemblyFile="$(VCTargetsPath)\Application Type\Android\bin\Android.MsBuild.DeployTasks.dll" />

  <UsingTask TaskName="VCMessage" AssemblyName="Microsoft.Build.CppTasks.Common, Version=4.0.0.0, Culture=neutral, PublicKeyToken=b03f5f7f11d50a3a" />

  <!--
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
  -->

  <PropertyGroup>

    <ComputeAndroidApkSignInputsTargets>$(ComputeAndroidApkSignInputsTargets);ComputeAndroidApkOutput;</ComputeAndroidApkSignInputsTargets>

    <CleanDependsOn>$(CleanDependsOn);CleanAndroidApkSign;</CleanDependsOn>

  </PropertyGroup>

  <!--
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
  -->

  <Target
    Name="_AndroidApkSign"
    Condition="'$(ConfigurationType)' == 'Application'"
    DependsOnTargets="$(ComputeAndroidApkSignInputsTargets)">
  </Target>

  <!--
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
  -->

  <Target
    Name="AndroidApkSign"
    BeforeTargets="$(AndroidApkSignBeforeTargets)"
    AfterTargets="$(AndroidApkSignAfterTargets)"
    DependsOnTargets="AndroidApk;_AndroidApkSign;">

    <!--
      Duplicate and sign the APK with specified credentials.
    -->

    <Copy
      Condition="'@(AndroidApkSign)' != ''"
      SourceFiles="@(AndroidApkSign)"
      DestinationFiles="%(AndroidApkSign.SignedOutputFile)">
      <Output TaskParameter="CopiedFiles" ItemName="AndroidApkSignSignedOutputFile" />
    </Copy>

    <ItemGroup>
      <AndroidApkSign>
        <CommandLineUnsignedJar>@(AndroidApkSignSignedOutputFile)</CommandLineUnsignedJar>
      </AndroidApkSign>
    </ItemGroup>

    <JavaSigner
      BuildingInIDE="$(BuildingInsideVisualStudio)"
      Condition="'@(AndroidApkSign)' != ''"
      Sources="@(AndroidApkSign)"
      TrackerLogDirectory="%(AndroidApkSign.TrackerLogDirectory)"
      TrackFileAccess="$(TrackFileAccess)"
      ToolPath="$(JavaHomeDir)\bin"
      ToolExe="jarsigner.exe"
      SignedOutputFile="@(AndroidApkSignSignedOutputFile)"
      OutputCommandLine="%(AndroidApkSign.OutputCommandLine)"
      PropertiesFile="$(MSBuildThisFileDirectory)$(MSBuildThisFileName).xml">
      <Output TaskParameter="OutputFiles" ItemName="AndroidApkSignSignedOutputFile" />
    </JavaSigner>

    <!--
      Align the signed APK. (Must be post-signing)
      - Using a custom deployment of zipalign to support files of sizes &gt; 2GB
    -->

    <ItemGroup>
      <AndroidApkSign Remove="@(AndroidApkSign)" />
      <AndroidApkSign Include="@(AndroidApkSignSignedOutputFile)"  />
    </ItemGroup>

    <AndroidZipAlign
      BuildingInIDE="$(BuildingInsideVisualStudio)"
      Condition="'@(AndroidApkSign)' != ''"
      Sources="@(AndroidApkSign)"
      TrackerLogDirectory="%(AndroidApkSign.TrackerLogDirectory)"
      TrackFileAccess="$(TrackFileAccess)"
      ToolPath="$(VCTargetsPath)\Application Type\Android\bin"
      ToolExe="app-zipalign.exe"
      OutputCommandLine="%(AndroidApkSign.OutputCommandLine)"
      AlignedZip="%(AndroidApkSign.SignedAlignedOutputFile)"
      PropertiesFile="$(MSBuildThisFileDirectory)$(MSBuildThisFileName).xml">
      <Output TaskParameter="OutputFiles" ItemName="AndroidApkSignSignedAlignedOutputFile" />
    </AndroidZipAlign>

    <Message
      Condition="'@(AndroidApkSignSignedAlignedOutputFile)' != ''"
      Text="$(MSBuildProjectFile) -&gt; @(AndroidApkSignSignedAlignedOutputFile)"
      Importance="High"
    />

  </Target>

  <!--
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
  -->

  <Target
    Name="ComputeAndroidApkSignOutput"
    DependsOnTargets="AndroidApkSign">

  </Target>

  <!--
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
  -->

  <Target Name="CleanAndroidApkSign">

  </Target>

  <!--
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
  -->

</Project>
